<!-- game/templates/game/no_active_game.html -->
{% extends 'game/base.html' %}
{% block title %}No Active Game - The Enchanted Forest Mystery{% endblock %}
{% block content %}
<div class="container">
    <div class="no-game-message">
        <div class="refresh-status">
            <div class="progress-container"><div class="progress"></div></div>
            <button id="refresh-button" class="button">Check Now</button>
        </div>
        <h3>There is no active forest adventure at the moment</h3>
        <p>Please wait for a Game Master to create and start a new adventure.</p>
        <p>This page will automatically check for new games every 30 seconds.</p>
    </div>
</div>

<script>
    // Auto-refresh functionality
    let progress = 0;
    const progressBar = document.querySelector('.progress');
    const refreshInterval = 30; // seconds
    const updateFrequency = 100; // ms
    const steps = (refreshInterval * 1000) / updateFrequency;
    const increment = 100 / steps;
    
    function resetProgress() {
        progress = 0;
        progressBar.style.width = '0%';
    }
    
    function updateProgress() {
        progress += increment;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
        
        if (progress >= 100) {
            checkForGame();
        }
    }
    
    function checkForGame() {
        fetch("{% url 'check_game_status' %}")
            .then(response => response.json())
            .then(data => {
                if (data.active_game) {
                    window.location.href = data.redirect_url;
                } else {
                    resetProgress();
                }
            })
            .catch(error => {
                console.error('Error checking game status:', error);
                resetProgress();
            });
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Start progress bar
        resetProgress();
        const progressTimer = setInterval(updateProgress, updateFrequency);
        
        // Setup manual refresh button
        document.getElementById('refresh-button').addEventListener('click', function() {
            resetProgress();
            checkForGame();
        });
    });
</script>
{% endblock %}